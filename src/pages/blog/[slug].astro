---
// src/pages/blog/[slug].astro
import type { GetStaticPaths } from "astro";

import BaseLayout from "@/layouts/base-layout.astro";
import { getAllPostSlugs, getPostBySlug } from "@/lib/ghost";

export const getStaticPaths: GetStaticPaths = async () => {
  const slugs = await getAllPostSlugs();
  return slugs.map((slug) => ({ params: { slug } }));
};

const { slug } = Astro.params;

if (!slug || typeof slug !== "string") {
  return Astro.redirect("/404");
}

const post = await getPostBySlug(slug);

if (!post) {
  return Astro.redirect("/404");
}

const publishedDate = new Date(post.published_at).toLocaleDateString("ko-KR", {
  weekday: "long",
  year: "numeric",
  month: "long",
  day: "numeric",
});

const pageTitle = `${post.title} | blog.duchi.click`;
const pageDescription = post.custom_excerpt || post.excerpt || "";
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  image={post.feature_image ?? undefined}
>
  <article class="container mx-auto max-w-4xl px-4 py-12">
    <header class="mb-12">
      {
        post.primary_tag && (
          <span class="badge badge-primary badge-lg mb-4">
            {post.primary_tag.name}
          </span>
        )
      }

      <h1 class="mb-6 text-4xl font-bold md:text-5xl">
        {post.title}
      </h1>

      <div class="flex items-center gap-4 text-base-content/70">
        {
          post.primary_author && (
            <div class="flex items-center gap-2">
              {post.primary_author.profile_image && (
                <img
                  src={post.primary_author.profile_image}
                  alt={post.primary_author.name}
                  class="h-10 w-10 rounded-full"
                />
              )}
              <span class="font-medium">{post.primary_author.name}</span>
            </div>
          )
        }
        <span>·</span>
        <time datetime={post.published_at}>{publishedDate}</time>
        <span>·</span>
        <span>{post.reading_time} min read</span>
      </div>

      {
        post.feature_image && (
          <figure class="mt-8 overflow-hidden rounded-lg">
            <img src={post.feature_image} alt={post.title} class="w-full" />
          </figure>
        )
      }
    </header>

    <div
      class="prose prose-lg prose-slate max-w-none dark:prose-invert"
      set:html={post.html}
    />

    <footer class="mt-16 border-t border-base-200 pt-8">
      <a href="/blog" class="btn btn-outline btn-primary">← Back to Blog</a>
    </footer>
  </article>
</BaseLayout>
