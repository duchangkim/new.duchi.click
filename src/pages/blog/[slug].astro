---
// src/pages/blog/[slug].astro
import type { GetStaticPaths } from 'astro';

import GiscusComments from '@/components/giscus-comments';
import AppLayout from '@/layouts/app-layout.astro';
import { processCodeBlocks } from '@/lib/code-highlight';
import { getAllPostSlugs, getPostBySlug } from '@/lib/ghost';

export const getStaticPaths: GetStaticPaths = async () => {
  const slugs = await getAllPostSlugs();
  return slugs.map((slug) => ({ params: { slug } }));
};

const { slug } = Astro.params;

if (!slug || typeof slug !== 'string') {
  return Astro.redirect('/404');
}

const post = await getPostBySlug(slug);

if (!post) {
  return Astro.redirect('/404');
}

const publishedDate = new Date(post.published_at).toLocaleDateString('ko-KR', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const pageTitle = `${post.title} | blog.duchi.click`;
const pageDescription = post.custom_excerpt || post.excerpt || '';

const processedHtml = await processCodeBlocks(post.html);
---

<AppLayout title={pageTitle} description={pageDescription} image={post.feature_image ?? undefined}>
  <article class="container mx-auto max-w-4xl px-4 py-12">
    <header class="mb-12">
      {
        post.primary_tag && (
          <span class="badge badge-primary badge-lg mb-4">{post.primary_tag.name}</span>
        )
      }

      <h1 class="mb-6 text-4xl font-bold md:text-5xl">
        {post.title}
      </h1>

      <div class="text-base-content/70 flex items-center gap-4">
        {
          post.primary_author && (
            <div class="flex items-center gap-2">
              {post.primary_author.profile_image && (
                <img
                  src={post.primary_author.profile_image}
                  alt={post.primary_author.name}
                  class="h-10 w-10 rounded-full"
                />
              )}
              <span class="font-medium">{post.primary_author.name}</span>
            </div>
          )
        }
        <span>·</span>
        <time datetime={post.published_at}>{publishedDate}</time>
        <span>·</span>
        <span>{post.reading_time} min read</span>
      </div>

      {
        post.feature_image && (
          <figure class="mt-8 overflow-hidden rounded-lg">
            <img src={post.feature_image} alt={post.title} class="w-full" />
          </figure>
        )
      }
    </header>

    <div class="prose prose-lg prose-slate dark:prose-invert max-w-none" set:html={processedHtml} />

    <GiscusComments
      client:visible
      repo="duchangkim/new.duchi.click"
      repoId="R_kgDOQuzFcQ"
      category="Announcements"
      categoryId="DIC_kwDOQuzFcc4C192b"
    />

    <footer class="border-base-200 mt-16 border-t pt-8">
      <a href="/blog" class="btn btn-outline btn-primary">← Back to Blog</a>
    </footer>
  </article>
</AppLayout>

<script>
  const COPY_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
  const CHECK_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;

  document.querySelectorAll('.code-block-container').forEach((container) => {
    const header = container.querySelector('.code-header');
    const pre = container.querySelector('pre');
    if (!header || !pre) return;

    const btn = document.createElement('button');
    btn.className = 'code-copy-btn';
    btn.setAttribute('aria-label', 'Copy code');
    btn.innerHTML = COPY_ICON;
    header.appendChild(btn);

    btn.addEventListener('click', async () => {
      const code = pre.textContent ?? '';
      await navigator.clipboard.writeText(code);
      btn.innerHTML = CHECK_ICON;
      btn.classList.add('copied');
      setTimeout(() => {
        btn.innerHTML = COPY_ICON;
        btn.classList.remove('copied');
      }, 2000);
    });
  });
</script>
